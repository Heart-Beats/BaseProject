import java.nio.file.Files

pluginManagement {
    repositories {
        maven { url 'https://maven.aliyun.com/repository/public' }
        maven { url 'https://maven.aliyun.com/repository/google' }
        maven { url = 'https://maven.aliyun.com/repository/gradle-plugin' }
        maven { url 'https://jitpack.io' }
        gradlePluginPortal()
        google()
        mavenCentral()
    }
}
dependencyResolutionManagement {
    repositoriesMode.set(RepositoriesMode.FAIL_ON_PROJECT_REPOS)
    repositories {
        maven { url 'https://maven.aliyun.com/repository/public' }
        maven { url 'https://maven.aliyun.com/repository/google' }
        maven { url 'https://jitpack.io' }

        // 配置 YouMa 仓库
        maven {
            name = "YouMa"

            url 'http://maven.pm.youmatech.com/repository/maven-releases/'

            credentials {
                username = 'youmaAdmin'
                password = '0JjlsIO6BV'
            }

            allowInsecureProtocol = true
        }
        google()
        mavenCentral()
    }
}

rootProject.name = "BaseProject"

include ':app'


def includeBuildProjects = ['libs/project', 'libs/uikit']

includeBuildProjects.forEach {
    println "开始添加构建 -------------> $it"
    includeBuild(it)
}

//setting.gradle 加载和评估配置阶段完成
gradle.settingsEvaluated {
    println '设置加载完毕'
}

//项目加载完成
gradle.projectsLoaded {
    println "${it} ---------> projectsLoaded"

    gradle.rootProject.buildscript {
        println '开始执行初始化配置脚本'
    }
}

gradle.addProjectEvaluationListener(new ProjectEvaluationListener() {
    void beforeEvaluate(Project project) {
        println "${project} -------------> beforeEvaluate"
    }

    void afterEvaluate(Project project, ProjectState state) {
        println "${project} -------------> afterEvaluate"
    }
})


//gradle.settingsEvaluated {
//    apply from: 'file_util.gradle'
//    includeBuildProjects.forEach {
//        copyLocalPropertiesForIncludeBuild(it)
//    }
//}


/**
 * Android Studio当前不会为IncludeBuild创建包含sdk.dir的local.properties
 * 使得没有ANDROID_HOME或等效环境变量时仅依赖根目录的local.properties无法编译IncludeBuild。
 * 为了使此含有IncludeBuild的项目和其他不含有IncludeBuild的普通Android工程一样可以在
 * 只有根目录的local.properties情况下正常编译，用此任务复制local.properties。
 */
def copyLocalPropertiesForIncludeBuild(includedBuild) {
    // 同步 buildSrc 配置
    def buildSrc = file('buildSrc')
    if (buildSrc.exists()) {
        def includedBuildBuildSrc = file("${includedBuild}/buildSrc")
        //        if (includedBuildBuildSrc.exists() && includedBuildBuildSrc.isDirectory()) {
        //            includedBuildBuildSrc.deleteDir()
        //        }

        println "开始拷贝根项目的 buildSrc 目录至 ----> $includedBuild 下"
        copyFile(buildSrc, includedBuildBuildSrc)
    }

    def rootFile = file('local.properties')
    if (rootFile.exists()) {
        def includeBuildLocalProperties = file("${includedBuild}/local.properties")
        if (!includeBuildLocalProperties.exists()) {
            Files.copy(rootFile.toPath(), includeBuildLocalProperties.toPath())
        }
    }
}